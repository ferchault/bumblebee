{% extends "layout.html" %}
{% block title %}Detail for <i>{{ system.name }}</i>{% endblock %}
{% block subtitle %}Show Entries{% endblock %}

{% load results_extras %}

{% block content %}
    <div class="row">
        <div class="col-md-6">
            <div class="info-box">
            <span class="info-box-icon bg-aqua"><i class="fa fa-reorder"></i></span>

            <div class="info-box-content">
              <span class="info-box-text">Molecular Dynamic Runs</span>
              <span class="info-box-number">{{ series.mdrun_set.count }}</span>
            </div>
          </div>
        </div>
        <div class="col-md-6">
            <div class="info-box">
            <span class="info-box-icon bg-aqua"><i class="fa fa-minus"></i></span>

            <div class="info-box-content">
              <span class="info-box-text">Single Point Calculations</span>
              <span class="info-box-number">{{ series.singlepoint_set.count }}</span>
            </div>
          </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="nav-tabs-custom">
            <ul class="nav nav-tabs pull-right">
              <li class="active"><a href="#tab_1-1" data-toggle="tab">Temperature</a></li>
              <li><a href="#tab_2-2" data-toggle="tab">Pressure</a></li>
              <li class="pull-left header"><i class="fa fa-th"></i>Ensemble Properties</li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane active" id="tab_1-1">
                    <div id="tester1" style="width:100%;height:350px;">
                        <div class="progress">
                        <div class="progress-bar progress-bar-aqua" role="progressbar" aria-valuenow="1" aria-valuemin="0" aria-valuemax="{{ series.mdrun_set.all|length }}" style="width: 0%"></div>
                            <br />
                        </div>

                        <div class="progress-text">something</div>
                    </div>
                </div>
            <script language="JavaScript">
                $(function () {
                    TESTER = $('#tester1');
                    mdruns = [{% for mdrun in series.mdrun_set.all %}{{ mdrun.id }},{% endfor %}]

                    // download data
                    xdata = []
                    ydata = []
                    for (i = 0; i < mdruns.length; i++) {
                        $.when($.ajax({
                            url: '/results/api/stepensemble/?fields=time,temperature&mdstep__mdrun=' + mdruns[i] + '&transpose',
                            async: true,
                            success: function(data) {
                                if (data[0] != undefined) {
                                    xdata = xdata.concat(data[0]['time'])
                                    ydata = ydata.concat(data[0]['temperature'])
                                }
                            }
                        })).then(function(data, textStatus, jqXHR){
                                ival = parseFloat($('#tester1 .progress-bar').attr('aria-valuenow'))
                                $('#tester1 .progress-text').html(ival + '/{{ series.mdrun_set.all|length }} items downloaded: ' + xdata.length + ' data points')
                                $('#tester1 .progress-bar').attr('aria-valuenow', ival+1)
                                $('#tester1  .progress-bar').attr('style', 'width: ' + ival*100/{{ series.mdrun_set.all|length }} + '%')
                                if (ival == {{ series.mdrun_set.all|length }}) {
                                    $('#tester1 .progress').remove()
                                    $('#tester1 .progress-text').remove()
                                    Plotly.plot( document.getElementById('tester1'), [{x:xdata, y: ydata}], {
                                        margin: { t: 0,  },
                                        xaxis: {
                                            title: 'Time [fs]',
                                            showline: true
                                        },
                                        yaxis: {
                                            title: 'Temperature [K',
                                            showline: true
                                        }
                                    });
                                }
                        })
                    }
                })
            </script>
              </div>
              <!-- /.tab-pane -->
              <div class="tab-pane" id="tab_2-2">

              </div>
              <!-- /.tab-pane -->
            </div>
            <!-- /.tab-content -->
          </div>
            <div id="tester" style="width:600px;height:250px;"></div>

        </div>
    </div>
{% endblock %}